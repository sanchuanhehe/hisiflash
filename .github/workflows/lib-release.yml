name: Library Release

on:
  push:
    tags:
      - 'lib-v[0-9]+.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Library release tag (e.g., lib-v0.2.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # Publish library to crates.io
  publish-library:
    name: Publish hisiflash to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          # Extract version number (lib-v0.2.0 -> 0.2.0)
          LIB_VERSION="${TAG#lib-v}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "lib_version=${LIB_VERSION}" >> $GITHUB_OUTPUT

      - name: Verify library version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep '^version = ' hisiflash/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ "$CARGO_VERSION" != "${{ steps.get_version.outputs.lib_version }}" ]; then
            echo "❌ Version mismatch: tag=${{ steps.get_version.outputs.lib_version }}, Cargo.toml=$CARGO_VERSION"
            exit 1
          fi
          echo "✅ Version verified: $CARGO_VERSION"

      - uses: dtolnay/rust-toolchain@stable

      - name: Install libudev
        run: sudo apt-get update && sudo apt-get install -y libudev-dev

      - name: Run tests
        run: cargo test -p hisiflash --all-features

      - name: Publish hisiflash (library)
        # Only publish stable releases (no pre-release suffix)
        if: ${{ !contains(steps.get_version.outputs.lib_version, '-') }}
        run: cargo publish -p hisiflash
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Create GitHub Release (library only)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: hisiflash (library) ${{ steps.get_version.outputs.lib_version }}
          body: |
            ## hisiflash library ${{ steps.get_version.outputs.lib_version }}
            
            This is a library-only release. For the CLI tool, see releases tagged `cli-v*`.
            
            ### Installation
            
            ```toml
            [dependencies]
            hisiflash = "${{ steps.get_version.outputs.lib_version }}"
            ```
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.lib_version, '-') }}
