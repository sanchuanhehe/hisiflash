# WS63 烧录协议分析

本文档基于 ws63flash 源码分析海思 WS63 芯片的烧录协议，作为 hisiflash 实现的参考。

## 1. 协议概述

WS63 烧录协议基于串口通信，主要包含两个层面：
1. **命令帧协议** - 海思私有的帧格式，用于控制命令
2. **YMODEM 协议** - 标准文件传输协议，用于数据传输

## 2. 命令帧格式

### 2.1 帧结构

```
┌──────────┬──────────┬─────────────────────────┬──────────┐
│  MAGIC   │  LENGTH  │        PAYLOAD          │   CRC    │
│ (4 bytes)│ (2 bytes)│   (CMD + SCMD + DATA)   │ (2 bytes)│
└──────────┴──────────┴─────────────────────────┴──────────┘
```

| 字段 | 大小 | 描述 |
|------|------|------|
| MAGIC | 4 字节 | 魔数 `0xDEADBEEF` (小端序: `EF BE AD DE`) |
| LENGTH | 2 字节 | 整个帧的长度 (小端序) |
| CMD | 1 字节 | 命令码 |
| SCMD | 1 字节 | 命令码的高低4位交换 `(cmd << 4) | (cmd >> 4)` |
| DATA | N 字节 | 命令数据 |
| CRC | 2 字节 | CRC16-XMODEM 校验 (从帧头到数据结束) |

### 2.2 命令定义

```rust
/// 命令类型枚举
pub enum CommandType {
    /// 握手命令 - 建立连接
    Handshake = 0xF0,
    /// 设置波特率
    SetBaudRate = 0x5A,
    /// 下载/擦除命令
    Download = 0xD2,
    /// 复位命令
    Reset = 0x87,
}
```

### 2.3 握手命令 (CMD_HANDSHAKE = 0xF0)

**请求数据 (8 字节):**
```
┌──────────────────┬──────────────────┐
│    BAUD RATE     │     MAGIC        │
│    (4 bytes)     │   (4 bytes)      │
└──────────────────┴──────────────────┘
```

| 字段 | 偏移 | 大小 | 默认值 | 描述 |
|------|------|------|--------|------|
| BAUD | 0 | 4 | 0x0001C200 (115200) | 期望的波特率 |
| MAGIC | 4 | 4 | 0x00000108 | 协议魔数 8N1? |

**应答 (成功):**
```
EF BE AD DE 0C 00 E1 1E 5A 00 ...
              ↑↑↑↑↑↑
              CMD=0xE1, SCMD=0x1E, ACK=0x5A
```

### 2.4 设置波特率命令 (CMD_SETBAUDR = 0x5A)

**请求数据 (8 字节):**
```
┌──────────────────┬──────────────────┐
│    BAUD RATE     │     MAGIC        │
│    (4 bytes)     │   (4 bytes)      │
└──────────────────┴──────────────────┘
```

| 波特率 | 值 (小端序) |
|--------|-------------|
| 115200 | 00 C2 01 00 |
| 921600 | 00 10 0E 00 |

### 2.5 下载命令 (CMD_DOWNLOADI = 0xD2)

**请求数据 (14 字节):**
```
┌──────────┬──────────┬──────────┬──────────┐
│   ADDR   │   LEN    │  ERASE   │  CONST   │
│ (4 bytes)│ (4 bytes)│ (4 bytes)│ (2 bytes)│
└──────────┴──────────┴──────────┴──────────┘
```

| 字段 | 偏移 | 大小 | 描述 |
|------|------|------|------|
| ADDR | 0 | 4 | 烧写地址 |
| LEN | 4 | 4 | 数据长度 |
| ERASE | 8 | 4 | 擦除大小 (向上取整到 8KB: `ceil(len/8192)*0x2000`) |
| CONST | 12 | 2 | 常量 `0x00 0xFF` |

**擦除全部 Flash 时:**
- ADDR = 0x00000000
- LEN = 0x00000000  
- ERASE = 0xFFFFFFFF
- CONST = 0x00 0xFF

### 2.6 复位命令 (CMD_RST = 0x87)

**请求数据 (2 字节):**
```
00 00
```

## 3. YMODEM 协议

### 3.1 控制字符

| 字符 | 值 | 描述 |
|------|-----|------|
| SOH | 0x01 | 128 字节数据包头 |
| STX | 0x02 | 1024 字节数据包头 |
| EOT | 0x04 | 传输结束 |
| ACK | 0x06 | 确认 |
| NAK | 0x15 | 否定确认 |
| C | 0x43 | 'C' 请求 CRC 模式 |

### 3.2 数据包格式

**128 字节包 (SOH):**
```
┌─────┬─────┬─────┬────────────┬──────────┐
│ SOH │ SEQ │ ~SEQ│   DATA     │  CRC16   │
│(1B) │(1B) │(1B) │  (128B)    │   (2B)   │
└─────┴─────┴─────┴────────────┴──────────┘
总长: 133 字节
```

**1024 字节包 (STX):**
```
┌─────┬─────┬─────┬────────────┬──────────┐
│ STX │ SEQ │ ~SEQ│   DATA     │  CRC16   │
│(1B) │(1B) │(1B) │  (1024B)   │   (2B)   │
└─────┴─────┴─────┴────────────┴──────────┘
总长: 1029 字节
```

### 3.3 传输流程

```
发送方                          接收方
   │                              │
   │      等待 'C'                │
   │<─────────────────────────────│
   │                              │
   │    Block 0 (文件信息)        │
   │  SOH 00 FF [filename\0size]  │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │    等待 'C'                  │
   │<─────────────────────────────│
   │                              │
   │    Block 1 (数据)            │
   │  STX 01 FE [data 1024B]      │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │    ... 更多数据块 ...        │
   │                              │
   │           EOT                │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │    Block 0 (结束标记)        │
   │  SOH 00 FF [空数据]          │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
```

### 3.4 Block 0 (文件信息包)

```
┌────────────────────────┬───────────────────────┬─────────┐
│      FILENAME          │       FILESIZE        │ PADDING │
│   (NUL terminated)     │   (hex string, NUL)   │  (0x00) │
└────────────────────────┴───────────────────────┴─────────┘
```

示例: 文件名 "app.bin", 大小 0x1234
```
61 70 70 2E 62 69 6E 00 30 78 31 32 33 34 00 00 00 ...
a  p  p  .  b  i  n  \0 0  x  1  2  3  4  \0 padding
```

## 4. FWPKG 固件包格式

### 4.1 文件结构

```
┌───────────────────────────────┐
│     FWPKG Header (12 bytes)   │
├───────────────────────────────┤
│    BIN Info #0 (56 bytes)     │
├───────────────────────────────┤
│    BIN Info #1 (56 bytes)     │
├───────────────────────────────┤
│           ...                 │
├───────────────────────────────┤
│    BIN Info #N (56 bytes)     │
├───────────────────────────────┤
│                               │
│       Binary Data             │
│                               │
└───────────────────────────────┘
```

### 4.2 FWPKG Header

```rust
#[repr(C, packed)]
pub struct FwpkgHeader {
    /// 魔数: 0xDEADBEEF (存储为 0xDFADBEEF 小端)
    /// 注意: 实际检查值是 0xEFBEADDF
    pub magic: u32,
    /// CRC16-XMODEM (从 cnt 字段到所有 bin_info 结束)
    pub crc: u16,
    /// BIN 文件数量
    pub cnt: u16,
    /// 固件总大小
    pub len: u32,
}
```

| 字段 | 偏移 | 大小 | 描述 |
|------|------|------|------|
| magic | 0 | 4 | `0xDFADBEEF` (小端存储) |
| crc | 4 | 2 | CRC16 校验 |
| cnt | 6 | 2 | 分区数量 (最大 16) |
| len | 8 | 4 | 固件总大小 |

### 4.3 BIN Info 结构

```rust
#[repr(C, packed)]
pub struct FwpkgBinInfo {
    /// 文件名 (最大 31 字符 + NUL)
    pub name: [u8; 32],
    /// 在 fwpkg 中的偏移
    pub offset: u32,
    /// 文件长度
    pub length: u32,
    /// 烧写地址
    pub burn_addr: u32,
    /// 烧写大小
    pub burn_size: u32,
    /// 类型: 0=loaderboot, 1=普通固件
    pub type_2: u32,
}
```

| 字段 | 偏移 | 大小 | 描述 |
|------|------|------|------|
| name | 0 | 32 | 文件名 |
| offset | 32 | 4 | 在包中的偏移 |
| length | 36 | 4 | 文件长度 |
| burn_addr | 40 | 4 | 烧写目标地址 |
| burn_size | 44 | 4 | 烧写大小 |
| type_2 | 48 | 4 | 分区类型 |

**type_2 类型定义:**
- `0` = LoaderBoot (必须首先烧写)
- `1` = 普通固件分区

## 5. 烧写流程

### 5.1 完整烧写流程 (--flash)

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 解析 FWPKG                            │
│  - 读取 header, 验证 magic 和 CRC                           │
│  - 解析所有 bin_info                                        │
│  - 找到 loaderboot (type_2 == 0)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 2. 握手建立连接                              │
│  - 发送 CMD_HANDSHAKE (带波特率)                            │
│  - 等待 ACK 序列: EF BE AD DE 0C 00 E1 1E 5A 00            │
│  - 如果非115200, 切换本地波特率                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              3. YMODEM 传输 LoaderBoot                      │
│  - 等待 'C'                                                 │
│  - 发送 Block 0 (文件信息)                                  │
│  - 发送数据块 (1024B/块)                                    │
│  - 发送 EOT                                                 │
│  - 发送空 Block 0 结束                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           4. (可选) 切换高波特率                             │
│  - 发送 CMD_SETBAUDR                                        │
│  - 等待 ACK                                                 │
│  - 切换本地波特率                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│            5. 循环烧写其他分区                               │
│  FOR each bin where type_2 == 1:                           │
│    - 发送 CMD_DOWNLOADI (地址, 长度, 擦除大小)              │
│    - 等待 ACK                                               │
│    - YMODEM 传输 bin 数据                                   │
│    - 延时 100ms (防止 MCU 不响应)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    6. 复位设备                               │
│  - 发送 CMD_RST                                             │
│  - 等待 "Reset" 或 "reset" 字符串                          │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 擦除流程 (--erase)

```
1. 握手建立连接
2. YMODEM 传输内置 LoaderBoot
3. 发送 CMD_DOWNLOADI (ADDR=0, LEN=0, ERASE=0xFFFFFFFF)
4. 复位设备
```

### 5.3 裸机二进制烧写 (--write)

```
1. 解析命令行参数: loaderboot.bin bin1@addr1 bin2@addr2 ...
2. 握手建立连接
3. YMODEM 传输用户提供的 loaderboot
4. (可选) 切换波特率
5. 循环:
   - 发送 CMD_DOWNLOADI
   - YMODEM 传输 bin 文件
6. 复位设备
```

## 6. CRC16-XMODEM 算法

```rust
const CRC16_TABLE: [u16; 256] = [
    0x0000, 0x1021, 0x2042, 0x3063, 0x4084, 0x50a5, 0x60c6, 0x70e7,
    0x8108, 0x9129, 0xa14a, 0xb16b, 0xc18c, 0xd1ad, 0xe1ce, 0xf1ef,
    // ... (完整表格见 ws63flash/src/ymodem.h)
];

pub fn crc16_xmodem(data: &[u8]) -> u16 {
    let mut crc: u16 = 0;
    for byte in data {
        crc = (crc << 8) ^ CRC16_TABLE[((crc >> 8) ^ (*byte as u16)) as usize & 0xFF];
    }
    crc
}
```

## 7. 重要常量

### 7.1 超时时间

| 操作 | 超时 |
|------|------|
| 设备复位等待 | 10 秒 |
| YMODEM 等待 'C' | 5 秒 |
| YMODEM 等待 ACK | 1.5 秒 |
| YMODEM 数据传输 | 10 秒 |
| UART 读取 | 2 秒 |

### 7.2 支持的波特率

```rust
pub const SUPPORTED_BAUD_RATES: &[u32] = &[
    115200,  // 默认
    230400,
    460800,
    921600,  // 推荐的高速率
];
```

### 7.3 地址映射 (WS63)

| 分区 | 典型地址 |
|------|----------|
| LoaderBoot | 烧写时自动处理 |
| FlashBoot | 0x220000 |
| App | 0x230000 |

## 8. 签名格式 (ws63sign)

对于裸机程序，需要添加签名头才能运行。

### 8.1 签名头结构 (0x300 字节)

```
┌─────────────────────────────────────┐  0x000
│   Root Public Key Header (0x100)   │
├─────────────────────────────────────┤  0x100
│     Code Info Header (0x200)       │
└─────────────────────────────────────┘  0x300
```

### 8.2 Root Public Key Header

```rust
#[repr(C, packed)]
pub struct RootPubkHeader {
    pub image_id: u32,       // 0x4B0F2D1E
    pub struct_ver: u32,     // 0x00010000
    pub struct_len: u32,     // 0x100
    pub key_owner_id: u32,   // 0x40
    pub _unknown: u32,       // 0x1
    pub key_id: u32,         // 0x1
    pub key_alg: u32,        // 0x2A13C812 (Brainpool256)
    pub ecc_curve_type: u32, // 0x2A13C812
    pub key_len: u32,        // 0x40
    // ... padding to 0x100
}
```

### 8.3 Code Info Header

```rust
#[repr(C, packed)]
pub struct CodeInfoHeader {
    pub image_id: u32,       // 0x4B0F2D2D
    pub struct_ver: u32,     // 0x00010000
    pub struct_len: u32,     // 0x200
    pub signature_len: u32,
    pub version_ext: u32,
    pub mask_ver_ext: u32,
    pub msid_ext: u32,
    pub mask_msid_ext: u32,
    pub code_addr: u32,      // 代码地址
    pub code_len: u32,       // 代码长度 (16字节对齐)
    pub code_hash: [u8; 32], // SHA256 哈希
    pub code_enc_flag: u32,  // 0x3C7896E1 (无加密)
    // ... padding to 0x200
}
```

## 9. 参考资源

- [HiSpark WS63 Bootloader 源码](https://gitee.com/HiSpark/fbb_ws63/tree/master/src/bootloader)
- [ws63flash 源码](ws63flash 项目)
- [fbb_burntool 源码](fbb_burntool 项目)
