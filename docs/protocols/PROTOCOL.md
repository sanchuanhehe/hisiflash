# HiSilicon SEBOOT Protocol Specification

本文档描述海思芯片（WS63、BS2X 系列）用于固件烧录的 SEBOOT 协议。

## 1. 概述

SEBOOT (Secure Boot) 是海思芯片使用的引导加载程序协议，支持：
- 通过 UART 下载固件
- eFuse/OTP 编程
- Flash 存储管理
- 设备配置

协议基于简单的帧格式，使用 CRC16 校验。

## 2. 帧格式

所有 SEBOOT 命令使用以下帧结构：

```
┌──────────┬──────────┬──────┬───────┬─────────────────┬──────────┐
│  MAGIC   │  LENGTH  │ TYPE │ ~TYPE │      DATA       │   CRC    │
│ (4 bytes)│ (2 bytes)│ (1B) │ (1B)  │   (variable)    │ (2 bytes)│
└──────────┴──────────┴──────┴───────┴─────────────────┴──────────┘
```

### 2.1 字段说明

| 字段 | 大小 | 描述 |
|------|------|------|
| Magic | 4 字节 | 固定值 `0xDEADBEEF` (小端序: `EF BE AD DE`) |
| Length | 2 字节 | 整帧长度，包含所有字段 (小端序) |
| Type | 1 字节 | 命令类型码 |
| ~Type | 1 字节 | Type 的位取反，或高低 4 位交换 `(cmd << 4) \| (cmd >> 4)` |
| Data | 可变 | 命令特定数据 |
| CRC16 | 2 字节 | 前面所有字节的 CRC16-XMODEM (小端序) |

### 2.2 CRC16-XMODEM 计算

```rust
fn crc16_xmodem(data: &[u8]) -> u16 {
    let mut crc: u16 = 0x0000;
    for byte in data {
        crc ^= (*byte as u16) << 8;
        for _ in 0..8 {
            if crc & 0x8000 != 0 {
                crc = (crc << 1) ^ 0x1021;
            } else {
                crc <<= 1;
            }
        }
    }
    crc
}
```

- 多项式: `0x1021`
- 初始值: `0x0000`
- 无最终异或
- 输入/输出不反转

## 3. 命令类型

| 代码 | 名称 | 描述 |
|------|------|------|
| `0xF0` | Handshake | 建立连接，协商波特率 |
| `0xE1` | ACK | 设备响应帧 |
| `0xD2` | DownloadFlashImage | 下载固件到 Flash |
| `0xC3` | DownloadOtpEfuse | 写入 OTP/eFuse 数据 |
| `0xB4` | UploadData | 从设备读取数据 |
| `0xA5` | ReadOtpEfuse | 读取 OTP/eFuse 数据 |
| `0x96` | FlashLock | 锁定 Flash 区域 |
| `0x87` | Reset | 复位设备 |
| `0x78` | DownloadFactoryBin | 下载工厂校准数据 |
| `0x69` | DownloadVersion | 下载版本信息 |
| `0x5A` | SetBaudRate | 更改 UART 波特率 |
| `0x4B` | DownloadNv | 下载 NV (非易失性) 数据 |
| `0x1E` | SwitchDfu | 切换到 DFU 模式 |

## 4. 命令详情

### 4.1 握手命令 (0xF0)

建立连接并协商通信参数。

**帧结构 (18 字节):**
```
+--------+--------+------+-------+----------+----------+----------+----------+--------+
| Magic  | Length | Type | ~Type | BaudRate | DataBits | StopBits | Parity   | CRC16  |
+--------+--------+------+-------+----------+----------+----------+----------+--------+
| 4 B    | 2 B    | 0xF0 | 0x0F  | 4 B      | 1 B      | 1 B      | 1 B      | 2 B    |
+--------+--------+------+-------+----------+----------+----------+----------+--------+
```

**参数:**
- BaudRate: 目标波特率 (如 115200, 921600)
- DataBits: 通常为 8
- StopBits: 通常为 1
- Parity: 0 = 无, 1 = 奇校验, 2 = 偶校验

**示例 (115200 波特率):**
```
EF BE AD DE    // Magic
12 00          // Length = 18
F0 0F          // Type = Handshake
00 C2 01 00    // BaudRate = 115200
08             // DataBits = 8
01             // StopBits = 1
00             // Parity = None
00             // FlowCtrl = None
XX XX          // CRC16
```

### 4.2 ACK 响应 (0xE1)

设备对命令的响应。

**帧结构 (12 字节):**
```
+--------+--------+------+-------+--------+-----------+--------+
| Magic  | Length | Type | ~Type | Result | ErrorCode | CRC16  |
+--------+--------+------+-------+--------+-----------+--------+
| 4 B    | 2 B    | 0xE1 | 0x1E  | 1 B    | 1 B       | 2 B    |
+--------+--------+------+-------+--------+-----------+--------+
```

**结果码:**
- `0x5A` - 成功
- `0x00` - 失败

**成功 ACK 示例:**
```
EF BE AD DE 0C 00 E1 1E 5A 00 XX XX
```

### 4.3 下载 Flash 镜像 (0xD2)

下载二进制数据到 Flash 存储器。

**帧结构 (24 字节):**
```
+--------+--------+------+-------+----------+---------+-----------+--------+--------+--------+
| Magic  | Length | Type | ~Type | FileAddr | FileLen | EraseSize | Formal | ~Formal| CRC16  |
+--------+--------+------+-------+----------+---------+-----------+--------+--------+--------+
| 4 B    | 2 B    | 0xD2 | 0x2D  | 4 B      | 4 B     | 4 B       | 1 B    | 1 B    | 2 B    |
+--------+--------+------+-------+----------+---------+-----------+--------+--------+--------+
```

**参数:**
- FileAddr: 写入的 Flash 地址
- FileLen: 写入的数据大小
- EraseSize: 写入前擦除的大小 (0xFFFFFFFF 表示全部擦除)
  - 计算公式: `ceil(len / 8192) * 0x2000`
- Formal: 0x00 正常写入, 0x01 ROM 写入

**擦除全部 Flash 时:**
```
ADDR = 0x00000000
LEN = 0x00000000  
ERASE = 0xFFFFFFFF
CONST = 0x00 0xFF
```

### 4.4 设置波特率 (0x5A)

更改 UART 通信速度。

**帧结构:**
```
+--------+--------+------+-------+----------+--------+--------+
| Magic  | Length | Type | ~Type | BaudRate | Magic2 | CRC16  |
+--------+--------+------+-------+----------+--------+--------+
| 4 B    | 2 B    | 0x5A | 0xA5  | 4 B      | 4 B    | 2 B    |
+--------+--------+------+-------+----------+--------+--------+
```

**常见波特率值 (小端序):**

| 波特率 | 值 |
|--------|-------------|
| 115200 | 00 C2 01 00 |
| 921600 | 00 10 0E 00 |

**参数:**
- BaudRate: 新波特率
- Magic2: 通常为 `0x0108`

### 4.5 下载 NV (0x4B)

下载非易失性配置数据。

**帧结构 (26 字节):**
```
+--------+--------+------+-------+------+------+-----------+------------+------+--------+
| Magic  | Length | Type | ~Type | Addr | Len  | EraseSize | EncItemCnt | Flag | CRC16  |
+--------+--------+------+-------+------+------+-----------+------------+------+--------+
| 4 B    | 2 B    | 0x4B | 0xB4  | 4 B  | 4 B  | 4 B       | 2 B        | 2 B  | 2 B    |
+--------+--------+------+-------+------+------+-----------+------------+------+--------+
```

### 4.6 复位 (0x87)

烧录后复位设备。

**帧结构 (12 字节):**
```
+--------+--------+------+-------+----------+--------+
| Magic  | Length | Type | ~Type | Reserved | CRC16  |
+--------+--------+------+-------+----------+--------+
| 4 B    | 2 B    | 0x87 | 0x78  | 2 B      | 2 B    |
+--------+--------+------+-------+----------+--------+
```

Reserved 数据: `00 00`

## 5. 镜像类型

下载镜像时支持以下类型：

| 值 | 类型 | 描述 |
|----|------|------|
| 0 | Loader | 第一阶段引导加载程序 (LoaderBoot) |
| 1 | Normal | 普通固件分区 |
| 2 | KvNv | 键值 NV 存储 |
| 3 | Efuse | eFuse 数据 |
| 4 | Otp | OTP 数据 |
| 5 | FlashBoot | 第二阶段加载程序 |
| 6 | Factory | 工厂校准数据 |
| 7 | Version | 版本信息 |
| 8-10 | Security A/B/C | 安全分区 |
| 11 | ProtocolA | 协议分区 |
| 12 | AppsA | 应用分区 |
| 13 | RadioConfig | 射频配置 |

## 6. YMODEM 数据传输协议

发送下载命令并收到 ACK 后，使用 YMODEM-1K 协议传输数据。

### 6.1 控制字符

| 字符 | 值 | 描述 |
|------|-----|------|
| SOH | 0x01 | 128 字节数据包头 |
| STX | 0x02 | 1024 字节数据包头 |
| EOT | 0x04 | 传输结束 |
| ACK | 0x06 | 确认 |
| NAK | 0x15 | 否定确认 |
| C | 0x43 | 'C' 请求 CRC 模式 |

### 6.2 数据包格式

**128 字节包 (SOH):**
```
┌─────┬─────┬─────┬────────────┬──────────┐
│ SOH │ SEQ │ ~SEQ│   DATA     │  CRC16   │
│(1B) │(1B) │(1B) │  (128B)    │   (2B)   │
└─────┴─────┴─────┴────────────┴──────────┘
总长: 133 字节
```

**1024 字节包 (STX):**
```
┌─────┬─────┬─────┬────────────┬──────────┐
│ STX │ SEQ │ ~SEQ│   DATA     │  CRC16   │
│(1B) │(1B) │(1B) │  (1024B)   │   (2B)   │
└─────┴─────┴─────┴────────────┴──────────┘
总长: 1029 字节
```

### 6.3 传输流程

```
发送方                          接收方
   │                              │
   │      等待 'C'                │
   │<─────────────────────────────│
   │                              │
   │    Block 0 (文件信息)        │
   │  SOH 00 FF [filename\0size]  │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │    等待 'C'                  │
   │<─────────────────────────────│
   │                              │
   │    Block 1-N (数据)          │
   │  STX xx yy [data 1024B]      │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │           EOT                │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
   │                              │
   │    Block 0 (结束标记)        │
   │  SOH 00 FF [空数据]          │
   │─────────────────────────────>│
   │                              │
   │           ACK                │
   │<─────────────────────────────│
```

### 6.4 Block 0 (文件信息包)

```
┌────────────────────────┬───────────────────────┬─────────┐
│      FILENAME          │       FILESIZE        │ PADDING │
│   (NUL terminated)     │   (hex string, NUL)   │  (0x00) │
└────────────────────────┴───────────────────────┴─────────┘
```

示例: 文件名 "app.bin", 大小 0x1234
```
61 70 70 2E 62 69 6E 00 30 78 31 32 33 34 00 00 00 ...
a  p  p  .  b  i  n  \0 0  x  1  2  3  4  \0 padding
```

## 7. FWPKG 固件包格式

### 7.1 文件结构

```
┌───────────────────────────────┐
│     FWPKG Header (12 bytes)   │
├───────────────────────────────┤
│    BIN Info #0 (56 bytes)     │
├───────────────────────────────┤
│    BIN Info #1 (56 bytes)     │
├───────────────────────────────┤
│           ...                 │
├───────────────────────────────┤
│    BIN Info #N (56 bytes)     │
├───────────────────────────────┤
│                               │
│       Binary Data             │
│                               │
└───────────────────────────────┘
```

### 7.2 FWPKG Header

```rust
#[repr(C, packed)]
pub struct FwpkgHeader {
    /// 魔数: 0xDFADBEEF (小端存储)
    pub magic: u32,
    /// CRC16-XMODEM (从 cnt 字段到所有 bin_info 结束)
    pub crc: u16,
    /// BIN 文件数量 (最大 16)
    pub cnt: u16,
    /// 固件总大小
    pub len: u32,
}
```

| 字段 | 偏移 | 大小 | 描述 |
|------|------|------|------|
| magic | 0 | 4 | `0xDFADBEEF` (小端存储) |
| crc | 4 | 2 | CRC16 校验 |
| cnt | 6 | 2 | 分区数量 (最大 16) |
| len | 8 | 4 | 固件总大小 |

### 7.3 BIN Info 结构

```rust
#[repr(C, packed)]
pub struct FwpkgBinInfo {
    /// 文件名 (最大 31 字符 + NUL)
    pub name: [u8; 32],
    /// 在 fwpkg 中的偏移
    pub offset: u32,
    /// 文件长度
    pub length: u32,
    /// 烧写地址
    pub burn_addr: u32,
    /// 烧写大小
    pub burn_size: u32,
    /// 类型: 0=loaderboot, 1=普通固件
    pub type_2: u32,
}
```

| 字段 | 偏移 | 大小 | 描述 |
|------|------|------|------|
| name | 0 | 32 | 文件名 |
| offset | 32 | 4 | 在包中的偏移 |
| length | 36 | 4 | 文件长度 |
| burn_addr | 40 | 4 | 烧写目标地址 |
| burn_size | 44 | 4 | 烧写大小 |
| type_2 | 48 | 4 | 分区类型 |

**type_2 类型定义:**
- `0` = LoaderBoot (必须首先烧写)
- `1` = 普通固件分区

## 8. 烧写流程

### 8.1 完整烧写流程

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 解析 FWPKG                            │
│  - 读取 header, 验证 magic 和 CRC                           │
│  - 解析所有 bin_info                                        │
│  - 找到 loaderboot (type_2 == 0)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 2. 握手建立连接                              │
│  - 发送 CMD_HANDSHAKE (带波特率)                            │
│  - 等待 ACK 序列: EF BE AD DE 0C 00 E1 1E 5A 00            │
│  - 如果非115200, 切换本地波特率                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              3. YMODEM 传输 LoaderBoot                      │
│  - 等待 'C'                                                 │
│  - 发送 Block 0 (文件信息)                                  │
│  - 发送数据块 (1024B/块)                                    │
│  - 发送 EOT                                                 │
│  - 发送空 Block 0 结束                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           4. (可选) 切换高波特率                             │
│  - 发送 CMD_SETBAUDR                                        │
│  - 等待 ACK                                                 │
│  - 切换本地波特率                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│            5. 循环烧写其他分区                               │
│  FOR each bin where type_2 == 1:                           │
│    - 发送 CMD_DOWNLOADI (地址, 长度, 擦除大小)              │
│    - 等待 ACK                                               │
│    - YMODEM 传输 bin 数据                                   │
│    - 延时 100ms (防止 MCU 不响应)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    6. 复位设备                               │
│  - 发送 CMD_RST                                             │
│  - 等待 "Reset" 或 "reset" 字符串                          │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 时序图

```
Host                              Device
  |                                  |
  |--- Handshake (0xF0) ------------>|
  |<-- ACK (0xE1, 0x5A) -------------|
  |                                  |
  |--- SetBaudRate (0x5A) ---------->|  (可选)
  |<-- ACK (0xE1, 0x5A) -------------|
  |    [切换波特率]                  |
  |                                  |
  |--- DownloadFlashImage (0xD2) --->|
  |<-- ACK (0xE1, 0x5A) -------------|
  |                                  |
  |<-- 'C' (YMODEM ready) -----------|
  |--- YMODEM Data Blocks ---------->|
  |<-- ACK per block ----------------|
  |--- EOT ------------------------->|
  |<-- ACK (Transfer complete) ------|
  |                                  |
  |--- Reset (0x87) ---------------->|
  |<-- ACK (0xE1, 0x5A) -------------|
  |    [设备复位]                    |
```

### 8.3 擦除流程

```
1. 握手建立连接
2. YMODEM 传输内置 LoaderBoot
3. 发送 CMD_DOWNLOADI (ADDR=0, LEN=0, ERASE=0xFFFFFFFF)
4. 复位设备
```

### 8.4 裸机二进制烧写

```
1. 解析命令行参数: loaderboot.bin bin1@addr1 bin2@addr2 ...
2. 握手建立连接
3. YMODEM 传输用户提供的 loaderboot
4. (可选) 切换波特率
5. 循环:
   - 发送 CMD_DOWNLOADI
   - YMODEM 传输 bin 文件
6. 复位设备
```

## 9. 签名格式 (ws63sign)

对于裸机程序，需要添加签名头才能运行。

### 9.1 签名头结构 (0x300 字节)

```
┌─────────────────────────────────────┐  0x000
│   Root Public Key Header (0x100)   │
├─────────────────────────────────────┤  0x100
│     Code Info Header (0x200)       │
└─────────────────────────────────────┘  0x300
```

### 9.2 Root Public Key Header

```rust
#[repr(C, packed)]
pub struct RootPubkHeader {
    pub image_id: u32,       // 0x4B0F2D1E
    pub struct_ver: u32,     // 0x00010000
    pub struct_len: u32,     // 0x100
    pub key_owner_id: u32,   // 0x40
    pub _unknown: u32,       // 0x1
    pub key_id: u32,         // 0x1
    pub key_alg: u32,        // 0x2A13C812 (Brainpool256)
    pub ecc_curve_type: u32, // 0x2A13C812
    pub key_len: u32,        // 0x40
    // ... padding to 0x100
}
```

### 9.3 Code Info Header

```rust
#[repr(C, packed)]
pub struct CodeInfoHeader {
    pub image_id: u32,       // 0x4B0F2D2D
    pub struct_ver: u32,     // 0x00010000
    pub struct_len: u32,     // 0x200
    pub signature_len: u32,
    pub version_ext: u32,
    pub mask_ver_ext: u32,
    pub msid_ext: u32,
    pub mask_msid_ext: u32,
    pub code_addr: u32,      // 代码地址
    pub code_len: u32,       // 代码长度 (16字节对齐)
    pub code_hash: [u8; 32], // SHA256 哈希
    pub code_enc_flag: u32,  // 0x3C7896E1 (无加密)
    // ... padding to 0x200
}
```

## 10. 重要常量

### 10.1 超时时间

| 操作 | 超时 |
|------|------|
| 设备复位等待 | 10 秒 |
| YMODEM 等待 'C' | 5 秒 |
| YMODEM 等待 ACK | 1.5 秒 |
| YMODEM 数据传输 | 10 秒 |
| UART 读取 | 2 秒 |

### 10.2 支持的波特率

```rust
pub const SUPPORTED_BAUD_RATES: &[u32] = &[
    115200,  // 默认
    230400,
    460800,
    921600,  // 推荐的高速率
];
```

### 10.3 地址映射 (WS63)

| 分区 | 典型地址 |
|------|----------|
| LoaderBoot | 烧写时自动处理 |
| FlashBoot | 0x220000 |
| App | 0x230000 |

## 11. 芯片特定说明

### 11.1 WS63
- 默认波特率: 115200
- 高速波特率: 921600
- 支持延迟波特率切换 (LoaderBoot 之后)

### 11.2 BS2X (BS21, BS25)
- 默认波特率: 115200
- 高速波特率: 最高 2000000
- 支持 USB DFU 模式

## 12. 错误处理

常见错误场景：
1. **未收到 ACK**: 重试握手或复位设备
2. **YMODEM 期间收到 NAK**: 重发当前块
3. **CRC 不匹配**: 帧损坏，重发命令
4. **超时**: 设备可能处于错误模式，需要断电重启

## 13. 参考资源

- [HiSpark WS63 Bootloader 源码](https://gitee.com/HiSpark/fbb_ws63/tree/master/src/bootloader)
- [ws63flash 项目](https://github.com/example/ws63flash)
- [fbb_burntool 项目](https://github.com/example/fbb_burntool)
- HiSilicon SDK 文档
